WITH base_query AS (
  SELECT DISTINCT
    CASE
      WHEN REGEXP_SUBSTR(C.REFERENCE, 'MSID\\s+\\d+') IS NOT NULL 
        THEN REGEXP_SUBSTR(C.REFERENCE, 'MSID\\s+\\d+')
      WHEN REGEXP_SUBSTR(C.NAME, 'MSID\\s+\\d+') IS NOT NULL 
        THEN REGEXP_SUBSTR(C.NAME, 'MSID\\s+\\d+')
      WHEN REGEXP_SUBSTR(C.REFERENCE, '[0-9]{13}') IS NULL
           AND REGEXP_SUBSTR(C.NAME, '[0-9]{13}') IS NULL 
        THEN C.REFERENCE
      WHEN REGEXP_SUBSTR(C.REFERENCE, '[0-9]{13}') IS NOT NULL 
        THEN REGEXP_SUBSTR(C.REFERENCE, '[0-9]{13}')
      ELSE 
        REGEXP_SUBSTR(C.NAME, '[0-9]{13}')
    END AS MPAN,
    C.CREATED_AT,
    UPPER(
      ARRAY_TO_STRING(
        ARRAY_COMPACT(
          ARRAY_CONSTRUCT(
            TRIM(C.ADDRESS_STREET),
            TRIM(C.ADDRESS_TOWN)
          )
        ),
        ', '
      )
    ) AS SITE_ADDRESS,
    C.ADDRESS_POSTAL_CODE AS SITE_POSTCODE,
    C.GEOLOCATION_LATITUDE,
    C.GEOLOCATION_LONGITUDE,
    C.GEOLOCATION,
    JMSN.VALUE AS MSN,
    MPAN || ' - ' || JMSN.VALUE AS RECORD_ID
  FROM BIGCHANGE2175EDFENERGYLTD.BIGCHANGE_2175_EDF_ENERGY_LTD.CONTACTS_V1 AS C
  LEFT JOIN BIGCHANGE2175EDFENERGYLTD.BIGCHANGE_2175_EDF_ENERGY_LTD.JOBS_V1 AS J
    ON C.ID = J._CONTACT_ID
  LEFT JOIN BIGCHANGE2175EDFENERGYLTD.BIGCHANGE_2175_EDF_ENERGY_LTD.JOB_CUSTOM_FIELDS_V1 AS JMSN
    ON J.ID = JMSN._JOB_ID 
       AND JMSN.LABEL = 'On Site MSN'
  QUALIFY ROW_NUMBER() OVER (
      PARTITION BY MPAN
      ORDER BY C.CREATED_AT DESC
  ) = 1
)
SELECT 
  MPAN,
  SITE_ADDRESS,
  SITE_POSTCODE,
  GEOLOCATION_LATITUDE,
  GEOLOCATION_LONGITUDE,
  GEOLOCATION,
  MSN,
  RECORD_ID
FROM base_query;
